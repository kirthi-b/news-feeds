<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Project Feeds</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      header { display:flex; gap:16px; align-items:baseline; flex-wrap:wrap; }
      .muted { color:#666; font-size: 14px; }

      .layout { display:grid; grid-template-columns: 280px 1fr; gap: 18px; }
      @media (max-width: 980px) { .layout { grid-template-columns: 1fr; } }

      .panel { border: 1px solid #e2e2e2; border-radius: 12px; padding: 14px; }
      .panel h3 { margin: 0 0 10px; font-size: 14px; color: #111; }
      .panel .group { margin: 10px 0 14px; }
      .panel label { display:flex; gap:8px; align-items:flex-start; font-size: 13px; color:#111; margin: 6px 0; }
      .panel .child { margin-left: 18px; }

      .controls { display:flex; gap:12px; flex-wrap:wrap; margin: 16px 0 14px; }
      input, select { padding: 8px 10px; font-size: 14px; }

      .grid { display:grid; grid-template-columns: 1fr; gap: 12px; }
      .card { border: 1px solid #e2e2e2; border-radius: 14px; padding: 14px; display:grid; grid-template-columns: 120px 1fr; gap: 14px; }
      @media (max-width: 640px) { .card { grid-template-columns: 1fr; } }

      .thumb { width: 120px; height: 90px; border-radius: 10px; border: 1px solid #eee; object-fit: cover; background: #fafafa; }
      .title { font-size: 16px; font-weight: 650; margin: 0; }
      .meta { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin: 6px 0 8px; color:#444; font-size: 13px; }
      .date { color:#666; }
      .blurb { color:#333; font-size: 13px; line-height: 1.35; margin: 0; }

      .pill { display:inline-flex; align-items:center; padding: 2px 10px; border-radius: 999px; font-size: 12px; border: 1px solid rgba(0,0,0,0.08); }
      .qtag { display:inline-block; margin-top: 10px; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; color:#555; }

      .row { display:flex; justify-content:space-between; gap: 12px; align-items:flex-start; }
      .actions { display:flex; gap:10px; align-items:center; }
      .iconbtn { display:inline-flex; width:28px; height:28px; align-items:center; justify-content:center; border: 1px solid #e2e2e2; border-radius: 10px; background: #fff; cursor: pointer; }
      .iconbtn:hover { background: #f7f7f7; }

      a { text-decoration: none; color: inherit; }
      a:hover { text-decoration: underline; }
      .empty { color:#666; }
      .small { font-size: 12px; color:#666; }
    </style>
  </head>
  <body>
    <header>
      <h1 style="margin:0;">Project Feeds</h1>
      <div class="muted" id="lastUpdated">Last updated: —</div>
    </header>

    <div class="controls">
      <input id="search" placeholder="Search title/source/blurb…" size="36" />
      <select id="sort">
        <option value="new">Sort: newest</option>
        <option value="old">Sort: oldest</option>
        <option value="az">Sort: title A–Z</option>
      </select>
      <div class="small" id="count"></div>
    </div>

    <div class="layout">
      <div class="panel">
        <h3>Filters</h3>
        <div class="group" id="filters"></div>
      </div>

      <div class="grid" id="list"></div>
    </div>

    <script>
      function hashHue(str) {
        let h = 0;
        for (let i = 0; i < str.length; i++) h = (h * 31 + str.charCodeAt(i)) >>> 0;
        return h % 360;
      }
      function pastelPillStyle(label) {
        const hue = hashHue(label);
        return `background: hsl(${hue} 70% 90%); color: hsl(${hue} 35% 25%);`;
      }
      function esc(s){ return (s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

      async function load() {
        const res = await fetch("./data.json", { cache: "no-store" });
        if (!res.ok) {
          document.getElementById("list").innerHTML = `<div class="empty">No data yet.</div>`;
          return;
        }
        const data = await res.json();
        const last = data.meta?.generated_at ? new Date(data.meta.generated_at) : null;
        document.getElementById("lastUpdated").textContent = "Last updated: " + (last ? last.toLocaleString() : "—");

        const items = Array.isArray(data.items) ? data.items : [];

        // Build bundle -> queries mapping
        const bundleMap = new Map();
        for (const it of items) {
          const b = it.bundle || "";
          const q = it.query || "";
          if (!b) continue;
          if (!bundleMap.has(b)) bundleMap.set(b, new Set());
          if (q) bundleMap.get(b).add(q);
        }

        // Render checkbox filter list with bundle + query (tag) children
        const filters = document.getElementById("filters");
        const bundleState = new Map(); // bundle -> checked bool
        const queryState = new Map();  // "bundle||query" -> checked bool

        function mkId(prefix, text) {
          return prefix + "_" + btoa(unescape(encodeURIComponent(text))).replace(/=+$/,"").replace(/[+/]/g,"_");
        }

        const bundles = [...bundleMap.keys()].sort((a,b)=>a.localeCompare(b));
        filters.innerHTML = bundles.map(b => {
          const bid = mkId("b", b);
          const qs = [...bundleMap.get(b)].sort((a,c)=>a.localeCompare(c));
          const children = qs.map(q => {
            const qid = mkId("q", b + "||" + q);
            return `
              <label class="child">
                <input type="checkbox" id="${qid}" data-bundle="${esc(b)}" data-query="${esc(q)}" checked />
                <span>${esc(q)}</span>
              </label>
            `;
          }).join("");
          return `
            <div style="margin-bottom:12px;">
              <label>
                <input type="checkbox" id="${bid}" data-bundle="${esc(b)}" checked />
                <span style="display:flex; gap:8px; align-items:center;">
                  <span class="pill" style="${pastelPillStyle(b)}">${esc(b)}</span>
                </span>
              </label>
              ${children}
            </div>
          `;
        }).join("");

        // Initialize all checked
        for (const b of bundles) bundleState.set(b, true);
        for (const b of bundles) for (const q of bundleMap.get(b)) queryState.set(b + "||" + q, true);

        // Wire interactions: bundle checkbox toggles all its queries
        for (const b of bundles) {
          const bid = mkId("b", b);
          const bEl = document.getElementById(bid);
          bEl.addEventListener("change", () => {
            const checked = bEl.checked;
            bundleState.set(b, checked);
            for (const q of bundleMap.get(b)) {
              const qid = mkId("q", b + "||" + q);
              const qEl = document.getElementById(qid);
              qEl.checked = checked;
              queryState.set(b + "||" + q, checked);
            }
            render();
          });

          for (const q of bundleMap.get(b)) {
            const qid = mkId("q", b + "||" + q);
            const qEl = document.getElementById(qid);
            qEl.addEventListener("change", () => {
              queryState.set(b + "||" + q, qEl.checked);
              // bundle checkbox becomes checked if any query is checked
              const any = [...bundleMap.get(b)].some(x => queryState.get(b + "||" + x));
              bEl.checked = any;
              bundleState.set(b, any);
              render();
            });
          }
        }

        const search = document.getElementById("search");
        const sort = document.getElementById("sort");
        const count = document.getElementById("count");

        function passesFilters(it) {
          const b = it.bundle || "";
          const q = it.query || "";
          if (!b) return false;
          const k = b + "||" + q;
          // if query missing, treat as bundle-only
          if (!q) return !!bundleState.get(b);
          return !!queryState.get(k);
        }

        function render() {
          const qtxt = (search.value || "").toLowerCase().trim();
          let filtered = items.filter(it => {
            if (!passesFilters(it)) return false;
            if (!qtxt) return true;
            const hay = `${it.title||""} ${it.source||""} ${it.blurb||""}`.toLowerCase();
            return hay.includes(qtxt);
          });

          const sortMode = sort.value;
          if (sortMode === "new") filtered.sort((a,b)=> (b.published_ts||0)-(a.published_ts||0));
          if (sortMode === "old") filtered.sort((a,b)=> (a.published_ts||0)-(b.published_ts||0));
          if (sortMode === "az") filtered.sort((a,b)=> (a.title||"").localeCompare(b.title||""));

          count.textContent = `${filtered.length} items`;

          const list = document.getElementById("list");
          if (!filtered.length) {
            list.innerHTML = `<div class="empty">No matches.</div>`;
            return;
          }

          list.innerHTML = filtered.map(it => {
            const d = it.published_ts ? new Date(it.published_ts*1000).toLocaleString() : "—";
            const b = esc(it.bundle || "");
            const src = esc(it.source || "");
            const title = esc(it.title || "Untitled");
            const blurb = esc((it.blurb || "").slice(0, 280));
            const url = it.url || "#";
            const img = it.image_url ? ` <img class="thumb" src="${it.image_url}" alt="" loading="lazy" /> ` : ` <div class="thumb"></div> `;
            const pillStyle = pastelPillStyle(it.bundle || "");
            const qtag = it.query ? `<div class="qtag">${esc(it.query)}</div>` : "";
            const pdf = it.pdf_path ? `./${it.pdf_path}` : null;

            const downloadBtn = pdf ? `
              <a class="iconbtn" href="${pdf}" title="Download PDF clipping" aria-label="Download PDF clipping">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <path d="M12 3v10m0 0l4-4m-4 4l-4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M5 15v4h14v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </a>
            ` : "";

            return `
              <div class="card">
                ${img}
                <div>
                  <div class="row">
                    <div class="meta">
                      <span class="pill" style="${pillStyle}">${b}</span>
                      <span>${src}</span>
                      <span class="date">${d}</span>
                    </div>
                    <div class="actions">
                      ${downloadBtn}
                    </div>
                  </div>
                  <div style="margin-top:4px;">
                    <a href="${url}" target="_blank" rel="noopener noreferrer">
                      <div class="title">${title}</div>
                    </a>
                  </div>
                  ${blurb ? `<p class="blurb">${blurb}</p>` : ""}
                  ${qtag}
                </div>
              </div>
            `;
          }).join("");
        }

        search.addEventListener("input", render);
        sort.addEventListener("change", render);
        render();
      }

      load();
    </script>
  </body>
</html>
